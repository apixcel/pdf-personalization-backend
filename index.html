<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Download PDF</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
      }
      body {
        margin: 0;
        background: #0b1020;
        color: #eef2ff;
        display: grid;
        place-items: center;
        min-height: 100vh;
      }
      .card {
        width: min(560px, 92vw);
        background: #121833;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      h1 {
        margin: 0 0 12px;
        font-size: 22px;
      }
      p.hint {
        margin: 0 0 18px;
        opacity: 0.85;
        font-size: 14px;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      input[type="text"] {
        flex: 1;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #2a3569;
        background: #0e1440;
        color: #eef2ff;
        outline: none;
      }
      input::placeholder {
        color: #9aa7d8;
      }
      button {
        padding: 12px 16px;
        border: 0;
        border-radius: 10px;
        background: #4f63ff;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin-top: 14px;
        font-size: 14px;
        min-height: 20px;
      }
      .ok {
        color: #9ee493;
      }
      .err {
        color: #ffb3b3;
      }
      .divider {
        height: 1px;
        background: #1b2550;
        margin: 18px 0;
      }
      .options {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        opacity: 0.9;
      }
      label {
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Download Your PDF</h1>
      <p class="hint">
        Enter the PDF ID (the <code>_id</code> of your <code>PdfForm</code> document), then click
        download.
      </p>

      <div class="row">
        <input
          id="pdfId"
          type="text"
          placeholder="e.g. 66b1234abcde567890123456"
          autocomplete="off"
        />
        <button id="downloadBtn">Download</button>
      </div>

      <div class="status" id="status" aria-live="polite"></div>

      <div class="divider"></div>

      <div class="options">
        <label><input id="openInNewTab" type="checkbox" />Also open in a new tab (viewer)</label>
      </div>
    </div>

    <script>
      // If your API is on a different origin, set this to that base URL and enable CORS on the server.
      const API_BASE = "http://localhost:5000/api/v1"; // e.g. "https://api.example.com" (leave empty for same-origin)

      const elId = document.getElementById("pdfId");
      const elBtn = document.getElementById("downloadBtn");
      const elStatus = document.getElementById("status");
      const elOpenTab = document.getElementById("openInNewTab");

      // Support ?id=... prefill
      (function prefillFromQuery() {
        const params = new URLSearchParams(location.search);
        const id = params.get("id");
        if (id) {
          elId.value = id;
          // Optionally auto-trigger download:
          // setTimeout(() => elBtn.click(), 100);
        }
      })();

      function setStatus(msg, type = "") {
        elStatus.textContent = msg || "";
        elStatus.className = "status " + (type ? type : "");
      }

      function getFilenameFromDisposition(disposition) {
        if (!disposition) return null;
        // Try RFC 5987 (filename*=UTF-8'') first, then fallback to filename=
        let m = /filename\*=(?:UTF-8'')?["']?([^"';]+)["']?/i.exec(disposition);
        if (m?.[1]) return decodeURIComponent(m[1]);
        m = /filename=["']?([^"']+)["']?/i.exec(disposition);
        return m?.[1] || null;
      }

      async function downloadPdf(id) {
        if (!id) {
          setStatus("Please enter a PDF id.", "err");
          return;
        }
        try {
          setStatus("Preparing your downloadâ€¦");
          elBtn.disabled = true;

          const res = await fetch(`${API_BASE}/pdf/stream/${encodeURIComponent(id)}`, {
            method: "GET",
            // If your route needs auth, add it here:
            // credentials: "include",
            // headers: { Authorization: `Bearer ${token}` }
          });

          // Handle non-2xx with readable message
          if (!res.ok) {
            const ct = res.headers.get("Content-Type") || "";
            let detail = "";
            try {
              if (ct.includes("application/json")) {
                const j = await res.json();
                detail = j?.message || JSON.stringify(j);
              } else {
                detail = await res.text();
              }
            } catch {}
            throw new Error(`Download failed (${res.status})${detail ? `: ${detail}` : ""}`);
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const cd = res.headers.get("Content-Disposition");
          const nameFromHeader = getFilenameFromDisposition(cd);
          const filename = nameFromHeader || "document.pdf";

          // Trigger a download
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();

          // Optional: also open in new tab for quick viewing
          if (elOpenTab.checked) {
            window.open(url, "_blank", "noopener,noreferrer");
          }

          // Revoke after a tick (allow other windows to use the URL if opened)
          setTimeout(() => URL.revokeObjectURL(url), 2000);

          setStatus(`Downloaded "${filename}".`, "ok");
        } catch (err) {
          console.error(err);
          setStatus(err?.message || "Unexpected error while downloading.", "err");
        } finally {
          elBtn.disabled = false;
        }
      }

      elBtn.addEventListener("click", () => downloadPdf(elId.value.trim()));
      elId.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          elBtn.click();
        }
      });
    </script>
  </body>
</html>
